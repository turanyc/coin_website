{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Turan/OneDrive/Masa%C3%BCst%C3%BC/my-crypto-tracker/my-crypto-tracker/src/pages/api/chart/%5BcoinId%5D.ts"],"sourcesContent":["// pages/api/chart/[coinId].ts\r\nimport { NextApiRequest, NextApiResponse } from 'next';\r\n\r\n// Basit in-memory cache\r\nconst cache = new Map<string, { data: any; timestamp: number }>();\r\nconst CACHE_DURATION = 5 * 60 * 1000; // 5 dakika\r\n\r\nexport default async function handler(req: NextApiRequest, res: NextApiResponse) {\r\n  const { coinId } = req.query;\r\n  const { days = '7' } = req.query;\r\n\r\n  if (!coinId || typeof coinId !== 'string') {\r\n    return res.status(400).json({ error: 'Coin ID gerekli' });\r\n  }\r\n\r\n  // Days parametresini sayıya çevir\r\n  const daysNum = parseInt(days as string, 10);\r\n  if (isNaN(daysNum) || daysNum < 1) {\r\n    return res.status(400).json({ error: 'Geçersiz days parametresi' });\r\n  }\r\n\r\n  // Cache key oluştur\r\n  const cacheKey = `${coinId}-${daysNum}`;\r\n  const cached = cache.get(cacheKey);\r\n  \r\n  // Cache kontrolü\r\n  if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {\r\n    return res.status(200).json(cached.data);\r\n  }\r\n\r\n  try {\r\n    // Timeout için AbortController kullan\r\n    const controller = new AbortController();\r\n    const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 saniye timeout\r\n\r\n    // CoinGecko Market Chart API'den veri çek\r\n    const response = await fetch(\r\n      `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=${daysNum}`,\r\n      {\r\n        headers: {\r\n          'Accept': 'application/json',\r\n          'User-Agent': 'Mozilla/5.0',\r\n        },\r\n        signal: controller.signal,\r\n      }\r\n    );\r\n\r\n    clearTimeout(timeoutId);\r\n\r\n    if (!response.ok) {\r\n      // 429 hatası durumunda cache'den eski veriyi döndür\r\n      if (response.status === 429 && cached) {\r\n        console.warn('Rate limit hatası, cache\\'den eski veri döndürülüyor');\r\n        return res.status(200).json({\r\n          ...cached.data,\r\n          warning: 'Rate limit nedeniyle önbellekten veri gösteriliyor',\r\n        });\r\n      }\r\n      \r\n      console.error(`CoinGecko Chart API hatası: ${response.status} ${response.statusText}`);\r\n      \r\n      let errorMessage = `API hatası: ${response.status}`;\r\n      if (response.status === 429) {\r\n        errorMessage = 'Çok fazla istek yapıldı. Lütfen birkaç dakika sonra tekrar deneyin.';\r\n      }\r\n      \r\n      return res.status(200).json({\r\n        prices: [],\r\n        priceData: [],\r\n        error: errorMessage,\r\n      });\r\n    }\r\n\r\n    const data = await response.json();\r\n\r\n    // Veri yapısını kontrol et\r\n    if (!data || !data.prices || !Array.isArray(data.prices)) {\r\n      console.error('Geçersiz Chart API yanıtı:', data);\r\n      return res.status(200).json({\r\n        prices: [],\r\n        error: 'Geçersiz API yanıtı',\r\n      });\r\n    }\r\n\r\n    // Fiyat ve timestamp'leri çıkar\r\n    const prices = data.prices.map((entry: [number, number]) => ({\r\n      timestamp: entry[0],\r\n      price: entry[1],\r\n    }));\r\n\r\n    // İlk ve son fiyatı hesapla (yüzdelik değişim için)\r\n    const firstPrice = prices[0]?.price || 0;\r\n    const lastPrice = prices[prices.length - 1]?.price || 0;\r\n    const priceChange = firstPrice > 0 ? ((lastPrice - firstPrice) / firstPrice) * 100 : 0;\r\n\r\n    const responseData = {\r\n      prices: prices.map((p: { timestamp: number; price: number }) => p.price),\r\n      priceData: prices,\r\n      priceChange,\r\n      firstPrice,\r\n      lastPrice,\r\n    };\r\n\r\n    // Cache'e kaydet\r\n    cache.set(cacheKey, {\r\n      data: responseData,\r\n      timestamp: Date.now(),\r\n    });\r\n\r\n    res.status(200).json(responseData);\r\n  } catch (error) {\r\n    console.error('Chart API Error:', error);\r\n\r\n    // Hata durumunda bile 200 döndür\r\n    res.status(200).json({\r\n      prices: [],\r\n      priceData: [],\r\n      priceChange: 0,\r\n      firstPrice: 0,\r\n      lastPrice: 0,\r\n      error: 'CoinGecko Chart API\\'den veri çekilemedi.',\r\n      details: error instanceof Error ? error.message : 'Bilinmeyen hata',\r\n    });\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}